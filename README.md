# Managed Kubernetes Auditing Toolkit (MKAT)

**Note**: At this time (pre-release), this is highly beta.

## Building

```bash
make
./mkat --help
```

## Usage

For now, please refer to the autogenerated CLI documentation in (docs)[./docs]. Pre-requisites:

* You need to be authenticated against an EKS cluster
* For find-role-relationships, you also need to be authenticated against the same AWS account as where the EKS cluster is running

## Sample outputs

### Find role relationships

```bash
$ mkat eks find-role-relationships datadog-pde-test-eks-cluster-us-east-1

2023/04/05 12:33:57 Retrieving cluster OIDC issuer
2023/04/05 12:33:58 Listing roles in the AWS account
2023/04/05 12:33:59 Listing K8s service accounts
+-------------+------------------------------+-----------------------------------------------+--------------------------------------------------------------------------------------------+
| NAMESPACE   | SERVICE ACCOUNT              | POD                                           | ASSUMABLE ROLE ARN                                                                         |
+-------------+------------------------------+-----------------------------------------------+--------------------------------------------------------------------------------------------+
| kube-system | aws-load-balancer-controller | aws-load-balancer-controller-56bbd74695-9sw79 | arn:aws:iam::677301038893:role/AmazonEKSLoadBalancerControllerRole                         |
|             |                              | aws-load-balancer-controller-56bbd74695-9sw79 | arn:aws:iam::677301038893:role/ChristopheSampleIRSARoleThatCanBeAssumedByAnyPodInCluster   |
|             |                              | aws-load-balancer-controller-56bbd74695-b7hb2 | arn:aws:iam::677301038893:role/AmazonEKSLoadBalancerControllerRole                         |
|             |                              | aws-load-balancer-controller-56bbd74695-b7hb2 | arn:aws:iam::677301038893:role/ChristopheSampleIRSARoleThatCanBeAssumedByAnyPodInCluster   |
+-------------+------------------------------+-----------------------------------------------+--------------------------------------------------------------------------------------------+
| default     | christophe-test-sa           | christophe-irsa-deployment-7b476dfdb5-hkxdg   | arn:aws:iam::677301038893:role/ChristopheSampleIRSARoleThatCanBeAssumedByAnyPodInCluster   |
|             |                              | christophe-irsa-deployment-7b476dfdb5-hkxdg   | arn:aws:iam::677301038893:role/ChristopheSampleIRSARoleThatCanBeAssumedByAnyPodInDefaultNS |
|             |                              | christophe-irsa-deployment-7b476dfdb5-hkxdg   | arn:aws:iam::677301038893:role/ChristopheSamplePodIRSARole                                 |
+-------------+------------------------------+-----------------------------------------------+--------------------------------------------------------------------------------------------+
```

### Find secrets

(Note: the secrets displayed below are fake)

```bash
$ mkat eks find-secrets
2023/04/05 12:34:30 Searching for AWS secrets in ConfigMaps...
2023/04/05 12:34:32 Analyzing 21 ConfigMaps...
2023/04/05 12:34:32 Searching for AWS secrets in Secrets...
2023/04/05 12:34:32 Analyzing 52 Secrets...
2023/04/05 12:34:32 Searching for AWS secrets in Pod definitions...
2023/04/05 12:34:33 Analyzing 17 Pod definitions...
+-----------+-----------+--------------------------------------------------------+------------------------------------------+
| NAMESPACE | TYPE      | NAME                                                   | VALUE                                    |
+-----------+-----------+--------------------------------------------------------+------------------------------------------+
| default   | ConfigMap | my-config (key my-app-config)                          | AKIAZ3MSJV4WWNKWW5FG                     |
| default   | ConfigMap | my-config (key my-app-config)                          | HP8lBRs8X50F/0nCAXqEPQ95+jlG/0pLdlNui2XF |
| default   | Pod       | nginx-with-aws-creds (environment variable AWS_ACCESS) | AKIAZ3MSJV4WWNKWW5FG                     |
| default   | Pod       | nginx-with-aws-creds (environment variable AWS_SECRET) | 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 |
+-----------+-----------+--------------------------------------------------------+------------------------------------------+
```

### Test IMDS access from pods

```eks
$ mkat eks test-imds-access
2023/04/05 12:35:27 Testing if IMDS is accessible to pods by creating a pod that attempts to access it
IMDS is accessible and allows any pod to retrieve credentials for the AWS role eksctl-datadog-pde-test-eks-clust-NodeInstanceRole-1BO32251HD3PV
```

## Vision tl;dr

* We show cloud-specific risks, not generic ones
* We only show effective risk, not "potential" / graph-based risk